<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Skilled Worker Salary Checker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; line-height: 1.5; }
    h1 { margin-bottom: .25rem; }
    .panel { background:#fafafa; padding:1.25rem; border:1px solid #ddd; border-radius:8px; margin-bottom:1.75rem; }
    label { font-weight:600; display:block; margin-top:.75rem; }
    input, select { width:100%; max-width:420px; padding:.45rem; border:1px solid #bbb; border-radius:5px; margin-top:.25rem; }
    button { margin-top:1rem; padding:.75rem 1.25rem; border:none; border-radius:5px; background:#0043a4; color:#fff; cursor:pointer; font-size:1rem; }
    button:hover { background:#00347e; }
    .info { background:#f2f7fc; border-left:4px solid #0043a4; padding:.75rem 1rem; margin-top:1rem; border-radius:4px; font-size:.9rem; }
    .result { padding:1rem; border-radius:8px; margin-top:1rem; }
    .ok { background:#eaf8ef; border:1px solid #1c7d3a; }
    .fail { background:#fdecee; border:1px solid #b62334; }
    .small { font-size:.85rem; color:#666; }
  </style>
</head>

<body>

<h1>Skilled Worker Salary Checker</h1>
<p class="small">
  This tool gives an indicative comparison against Skilled Worker visa salary rules.
  Always verify figures on GOV.UK and seek legal advice for immigration decisions.
</p>

<div class="panel">
  <h2>1. Find the occupation</h2>

  <label>Search job title or SOC code</label>
  <input id="searchJob" type="text" placeholder="e.g. nurse, engineer, 2231…">

  <label>Select SOC code</label>
  <select id="socSelect">
    <option>Loading SOC codes…</option>
  </select>

  <div id="jobInfo" class="small"></div>

  <div class="info small">
    Standard Occupational Classification (SOC) codes group jobs by their main duties.
    Match based on duties rather than job title alone.
  </div>
</div>

<div class="panel">
  <h2>2. Hours & salary</h2>

  <label>Weekly hours</label>
  <input id="hours" type="number" value="37.5" min="1" step="0.1">

  <label>Proposed annual salary (£)</label>
  <input id="salary" type="number" step="100">

  <div class="info small">
    Salaries must meet the higher of the relevant general threshold,
    the going rate for the occupation, and the minimum hourly rate.
    Only guaranteed basic pay and guaranteed allowances can be counted.
  </div>
</div>

<div class="panel">
  <h2>3. Scenario</h2>

  <label><input type="radio" name="scenario" value="standard" checked> Standard rate</label>
  <label><input type="radio" name="scenario" value="newEntrant"> New entrant rate</label>
  <label><input type="radio" name="scenario" value="phdNonStem"> PhD (non-STEM)</label>
  <label><input type="radio" name="scenario" value="phdStem"> PhD (STEM)</label>
  <label><input type="radio" name="scenario" value="isl"> Immigration Salary List (ISL)</label>

  <div class="info small">
    Discounts can only be used where the applicant meets the full eligibility criteria.
    This tool only models the salary maths and does not confirm legal eligibility.
  </div>
</div>

<div class="panel">
  <h2>4. Check salary</h2>

  <button id="checkBtn">Check salary</button>
  <div id="results"></div>

  <div class="info small">
    This calculator is indicative only. Always cross-check against the latest GOV.UK guidance.
  </div>
</div>

<script>
  const GENERAL_THRESHOLD   = 41700;
  const FLOOR_NEW_ENTRANT   = 33400;
  const FLOOR_PHD_NON_STEM  = 37500;
  const HOURLY_MIN          = 17.13;
  const WEEKS_PER_YEAR      = 52;
  const MAX_HOURS_FOR_TEST  = 48;

  let socData = [];

  async function loadCSV() {
    try {
      const response = await fetch("2_soc_full_for_calculator.csv?nocache=" + Date.now());
      const text = await response.text();

      const rows = text.trim().split("\n");
      const headers = rows.shift().split(",");

      socData = rows.map(row => {
        const cols = row.split(",");
        const obj = {};
        headers.forEach((h, i) => obj[h.trim()] = cols[i]?.trim() || "");

        if (!obj.Job_title && obj.Job_type) obj.Job_title = obj.Job_type;
        if (!obj.Job_type && obj.Job_title) obj.Job_type = obj.Job_title;

        return obj;
      });

      populateDropdown(socData);
    } catch (err) {
      console.error("CSV load failed:", err);
      alert("CSV failed to load.");
    }
  }

  function populateDropdown(list) {
    const select = document.getElementById("socSelect");
    select.innerHTML = "";

    list.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.SOC_code;
      opt.textContent = `${r.SOC_code} — ${r.Job_title || "Unknown"}`;
      select.appendChild(opt);
    });

    updateJobInfo();
  }

  function updateJobInfo() {
    const soc = document.getElementById("socSelect").value;
    const role = socData.find(r => r.SOC_code === soc);
    const infoDiv = document.getElementById("jobInfo");

    if (!role) return (infoDiv.textContent = "");

    const standard = Number(role.Standard_going_rate_annual) || 0;
    const lower    = Number(role.Lower_going_rate_annual) || 0;

    infoDiv.textContent =
      `Standard annual going rate: £${standard.toLocaleString()} ` +
      (lower ? `(lower rate: £${lower.toLocaleString()})` : "");
  }

  document.getElementById("searchJob").addEventListener("input", function () {
    const q = this.value.toLowerCase();
    const filtered = socData.filter(r =>
      (r.SOC_code || "").toLowerCase().includes(q) ||
      (r.Job_title || "").toLowerCase().includes(q) ||
      (r.Related_job_titles || "").toLowerCase().includes(q)
    );
    populateDropdown(filtered.length ? filtered : socData);
  });

  document.getElementById("socSelect").addEventListener("change", updateJobInfo);

  document.getElementById("checkBtn").addEventListener("click", function () {
    const soc = document.getElementById("socSelect").value;
    const role = socData.find(r => r.SOC_code === soc);
    const offered = Number(document.getElementById("salary").value);
    const hours = Math.min(Number(document.getElementById("hours").value), MAX_HOURS_FOR_TEST);
    const scenario = document.querySelector("input[name='scenario']:checked").value;

    if (!role || !offered || !hours) return alert("Enter all values.");

    const goingRate = Number(role.Standard_going_rate_annual) || 0;

    let required = scenario === "standard" ? Math.max(GENERAL_THRESHOLD, goingRate)
      : scenario === "newEntrant" ? Math.max(goingRate * 0.7, FLOOR_NEW_ENTRANT)
      : scenario === "phdNonStem" ? Math.max(goingRate * 0.9, FLOOR_PHD_NON_STEM)
      : scenario === "phdStem" ? Math.max(goingRate * 0.8, FLOOR_NEW_ENTRANT)
      : Math.max(goingRate, FLOOR_NEW_ENTRANT);

    const offeredHourly = offered / (hours * WEEKS_PER_YEAR);
    const meetsHourly = offeredHourly >= HOURLY_MIN;

    const results = document.getElementById("results");
    results.innerHTML = "";

    const div = document.createElement("div");
    div.className = "result " + ((offered >= required && meetsHourly) ? "ok" : "fail");

    div.innerHTML =
      offered >= required && meetsHourly
        ? `<strong>Meets salary rules.</strong><br>Required: £${required.toLocaleString()}<br>Offer: £${offered.toLocaleString()} (~£${offeredHourly.toFixed(2)}/hr)`
        : `<strong>Does not meet salary rules.</strong>`;

    results.appendChild(div);
  });

  loadCSV();
</script>

</body>
</html>

